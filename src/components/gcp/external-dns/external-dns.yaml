# ExternalDNS GCP Service Account
- op: add
  path: /spec/resources/-1
  value:
    name: external-dns-gcp-sa
    base:
      apiVersion: iam.gcp.crossplane.io/v1alpha1
      kind: ServiceAccount
      metadata:
        annotations: 
          crossplane.io/external-name: workload-external-dns
      spec:
        forProvider:
          description: Workload identity for External DNS
          displayName: External DNS Workload
    patches:
    - type: PatchSet
      patchSetName: metadata
    - type: FromCompositeFieldPath
      fromFieldPath: spec.claimRef.namespace
      toFieldPath: spec.providerConfigRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-external-dns-gcp"
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.email
      toFieldPath: status.serviceAccounts.externalDns.email
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.name
      toFieldPath: status.serviceAccounts.externalDns.name
# External DNS GCP Provider Kubernetes Service Account Policy
- op: add
  path: /spec/resources/-1
  value:
    name: external-dns-gcp-ksa-policy
    base:
      apiVersion: iam.gcp.crossplane.io/v1alpha1
      kind: ServiceAccountPolicy
      metadata:
        annotations: 
          crossplane.io/external-name: workload-external-dns-policy
      spec:
        forProvider:
          policy:
            bindings:
            - role: roles/iam.workloadIdentityUser
    patches:
    - type: PatchSet
      patchSetName: metadata
    - type: FromCompositeFieldPath
      fromFieldPath: spec.claimRef.namespace
      toFieldPath: spec.providerConfigRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-workload-external-dns"
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.serviceAccountRef.name
      transforms:
      - type: string
        string:
          fmt: "%s-external-dns-gcp"
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.google.projectId
      toFieldPath: spec.forProvider.policy.bindings[0].members[0]
      transforms:
      - type: string
        string:
          fmt: "serviceAccount:%s.svc.id.goog[external-dns/external-dns]"
      policy:
        fromFieldPath: Required