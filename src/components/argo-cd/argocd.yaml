---
- op: add
  path: /spec/resources/-1
  value:
    name: argo-cd
    base:
      apiVersion: helm.crossplane.io/v1beta1
      kind: Release
      metadata:
        annotations: 
          crossplane.io/external-name: argocd
      spec:
        forProvider:
          chart:
            name: argo-cd
            repository: https://argoproj.github.io/argo-helm
            version: 4.2.1
          namespace: argocd
          wait: true
        rollbackLimit: 5
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.providerConfigRef.name
      transforms:
      - type: string
        string:
          fmt: "%s-cluster"
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-argo-cd"
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.argoCd.host
      toFieldPath: spec.forProvider.values.server.config.url
      transforms:
      - type: string
        string:
          fmt: "https://%s"

- op: add
  path: /spec/resources/-1
  value:
    name: argocd-project
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: Object
      metadata:
        annotations: 
          crossplane.io/external-name: argocd-project-cluster
      spec:
        forProvider:
          manifest:
            apiVersion: argoproj.io/v1alpha1
            kind: AppProject
            metadata:
              name: cluster
              namespace: argocd
              finalizers:
                - resources-finalizer.argocd.argoproj.io
            spec:
              description: Cluster admin project
              sourceRepos:
              - '*'
              destinations:
              - namespace: '*'
                server: '*'
              clusterResourceWhitelist:
              - group: '*'
                kind: '*'
              - group: 'rbac.authorization.k8s.io/v1'
                kind: 'ClusterRole'
              roles:
              - name: admin
                description: Admin privileges to cluster
                policies:
                - p, proj:cluster:admin, applications, *, cluster/*, allow
                groups: []
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.providerConfigRef.name
      transforms:
      - type: string
        string:
          fmt: "%s-cluster"
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-argocd-cluster-project"
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.argocd.admins
      toFieldPath: spec.forProvider.manifest.spec.roles[0].groups

- op: add
  path: /spec/resources/-1
  value:
    name: argocd-app
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: Object
      metadata:
        annotations: 
          crossplane.io/external-name: argocd-cluster-app
      spec:
        forProvider:
          manifest:
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
              name: apps
              namespace: argocd
              annotations:
                argocd.argoproj.io/sync-wave: "-100"
              finalizers:
                - resources-finalizer.argocd.argoproj.io
            spec:
              destination:
                namespace: argocd
                server: https://kubernetes.default.svc
              project: cluster
              source: {}
              syncPolicy:
                automated:
                  selfHeal: true
                  prune: true
                  allowEmpty: true       
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.providerConfigRef.name
      transforms:
      - type: string
        string:
          fmt: "%s-cluster"
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-argocd-cluster-app"
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.argocd.repo
      toFieldPath: spec.forProvider.manifest.spec.source.repoURL
      policy:
        fromFieldPath: Required
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.argocd.path
      toFieldPath: spec.forProvider.manifest.spec.source.path